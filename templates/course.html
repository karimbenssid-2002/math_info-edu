<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ chapitre.replace('_', ' ') }} - {{ matiere }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
    </script>

    {% if is_informatique %}
    <!-- Int√©gration de PyScript 2025.10.1 -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.10.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2025.10.1/core.js"></script>
    <style>
        .pyscript-terminal {
            margin-top: 30px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 25px;
            background-color: var(--card-bg);
            box-shadow: var(--shadow-sm);
        }

        .pyscript-terminal h3,
        .pyscript-terminal p {
            color: var(--text-main);
        }

        .pyscript-terminal h3 {
            margin-top: 0;
            font-size: 1.4rem;
        }

        /* La console Python g√®re nativement le th√®me via l'attribut js "theme" */
    </style>
    {% endif %}

    <!-- Int√©gration de MathJax pour le rendu des formules Math√©matiques -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
        </script>
</head>

<body>
    <header class="navbar">
        <div class="nav-brand">
            <a href="{{ url_for('index') }}" class="back-link">&larr; Retour au tableau de bord</a>
        </div>
        <div class="nav-actions">
            <button id="theme-toggle" class="theme-toggle" title="Changer de th√®me">
                <span class="icon-sun">‚òÄÔ∏è</span>
                <span class="icon-moon">üåô</span>
            </button>
            <div class="nav-user">
                {{ user.Nom }} ({{ user.Niveau_Classe }})
                <a href="{{ url_for('logout') }}" class="btn-logout">D√©connexion</a>
            </div>
        </div>
    </header>

    <main class="course-container">
        <div class="breadcrumb">
            {{ matiere }} / {{ user.Niveau_Classe }} / <strong>{{ chapitre.replace('_', ' ') }}</strong>
        </div>

        <article class="markdown-content">
            {{ content|safe }}
        </article>

        {% if is_informatique %}
        <section class="pyscript-terminal">
            <h3>Console Python</h3>
            <p>Utilisez cette console pour tester votre code Python directement dans le navigateur. √âcrivez votre script
                ci-dessous, puis cliquez sur le bouton <strong>Ex√©cuter</strong>.</p>

            <!-- PyScript 2025 Editor -->
            <script type="py-editor" id="main-editor">
# Testez votre code ici !
print("Bienvenue dans l'√©diteur Python !")
            </script>
        </section>
        {% endif %}
    </main>
    <script src="{{ url_for('static', filename='theme.js') }}"></script>

    <!-- Script pour injecter dynamiquement le th√®me sombre √† l'√©diteur PyScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // Helper function to inject CSS into any element or shadow root
            const injectCSS = (root, isDark) => {
                let styleEl = root.querySelector('#pyscript-custom-overrides');

                if (isDark) {
                    if (!styleEl) {
                        styleEl = document.createElement('style');
                        styleEl.id = 'pyscript-custom-overrides';
                        styleEl.textContent = `
                            /* Hide badges regardless of class structure */
                            a[href*="pyodide"], a[href*="pyscript"], a[href*="micropython"], .py-editor-badge, .polyscript-badge, .py-title {
                                display: none !important;
                                opacity: 0 !important;
                                visibility: hidden !important;
                            }
                            
                            /* Lighter grey background for the editor */
                            .cm-editor, .cm-gutters {
                                background-color: #4a4a4a !important;
                            }
                            
                            /* Neutralize active line heavily */
                            .cm-editor .cm-activeLine, .cm-editor.cm-focused .cm-activeLine, 
                            .cm-editor .cm-activeLineGutter, .cm-editor.cm-focused .cm-activeLineGutter {
                                background-color: transparent !important;
                                background: transparent !important;
                            }
                            
                            /* White base text (inherits to standard text, allows spans to keep colors) */
                            .cm-content, .cm-line { color: #f8f8f2 !important; }
                            
                            /* Ensure pyodide is stripped */
                            [data-env="pyodide"]::after, .py-editor-box::after { display: none !important; content: none !important; }
                        `;
                        root.appendChild(styleEl);
                    }
                } else {
                    if (styleEl) styleEl.remove();
                }

                // Forcefully remove text nodes of 'pyodide' if traversing child nodes
                Array.from(root.querySelectorAll ? root.querySelectorAll('*') : []).forEach(el => {
                    if (el.textContent && el.textContent.trim().toLowerCase() === 'pyodide' && el.tagName !== 'SCRIPT' && el.tagName !== 'STYLE' && el.children.length === 0) {
                        el.style.setProperty('display', 'none', 'important');
                    }
                });
            };

            const updatePyScriptTheme = () => {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

                // Inject in global document head just in case CodeMirror leaks into light DOM
                injectCSS(document.head, isDark);

                // Traverse ALL elements to find shadow roots (PyScript encapsulates CodeMirror heavily)
                document.querySelectorAll('*').forEach(el => {
                    if (el.shadowRoot) {
                        injectCSS(el.shadowRoot, isDark);
                    }
                });

                // Update standard theme attributes on known editor tags
                document.querySelectorAll('py-editor, script[type="py-editor"]').forEach(editor => {
                    if (isDark) {
                        editor.setAttribute('theme', 'dark');
                    } else {
                        editor.removeAttribute('theme');
                    }
                });
            };

            // Observer les changements de th√®me
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                        updatePyScriptTheme();
                    }
                });
            });

            observer.observe(document.documentElement, { attributes: true });

            // Apply continuously to ensure we catch PyScript rendering asynchronously
            setInterval(updatePyScriptTheme, 500);
        });
    </script>
</body>

</html>